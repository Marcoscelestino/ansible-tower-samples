---
- name: Simulação de Integração com ServiceNow
  hosts: localhost
  connection: local
  tasks:
    - name: Criar um novo incidente
      community.general.servicenow_incident:
        state: present
        instance: "{{ servicenow_instance }}"
        username: "{{ servicenow_user }}"
        password: "{{ servicenow_password }}"
        short_description: "Incidente de teste criado pelo Ansible"
        description: "Este é um incidente de teste para simular a integração com o ServiceNow."
      register: new_incident

    - name: Exibir número do incidente criado
      ansible.builtin.debug:  
        var: new_incident.incident.number

    - name: Aguardar 5 segundos para o incidente ser processado
      ansible.builtin.wait_for:
        timeout: 5

    - name: Consultar o incidente criado
      community.general.servicenow_incident:
        instance: "{{ servicenow_instance }}"
        username: "{{ servicenow_user }}"
        password: "{{ servicenow_password }}"
        query: "number={{ new_incident.incident.number }}"
      register: retrieved_incident

    - name: Verificar se o incidente foi encontrado
      fail:
        msg: "Incidente não encontrado após a criação."
      when: retrieved_incident.result | length == 0

    - name: Exibir informações do incidente criado
      ansible.builtin.debug:
        var: retrieved_incident.result[0]  

    - name: Atualizar o incidente com uma nova descrição
      community.general.servicenow_incident:
        state: present
        instance: "{{ servicenow_instance }}"
        username: "{{ servicenow_user }}"
        password: "{{ servicenow_password }}"
        number: "{{ new_incident.incident.number }}"
        description: "Descrição do incidente atualizada pelo Ansible"

    - name: Aguardar 5 segundos para o incidente ser processado
      ansible.builtin.wait_for:
        timeout: 5

    - name: Consultar o incidente atualizado
      community.general.servicenow_incident:
        instance: "{{ servicenow_instance }}"
        username: "{{ servicenow_user }}"
        password: "{{ servicenow_password }}"
        query: "number={{ new_incident.incident.number }}"
      register: updated_incident

    - name: Verificar se o incidente foi encontrado
      fail:
        msg: "Incidente não encontrado após a atualização."
      when: updated_incident.result | length == 0

    - name: Exibir informações do incidente atualizado
      ansible.builtin.debug:
        var: updated_incident.result[0]  
